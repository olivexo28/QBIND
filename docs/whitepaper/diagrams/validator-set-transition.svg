<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600" width="900" height="600">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2563eb"/>
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="900" height="600" fill="#fafafa"/>
  
  <!-- Title -->
  <text x="450" y="35" font-family="Arial, sans-serif" font-size="20" font-weight="bold" text-anchor="middle" fill="#1f2937">Validator Set Transition at Epoch Boundary</text>
  
  <!-- CandidateSet Box -->
  <rect x="50" y="80" width="180" height="120" rx="8" fill="#e0f2fe" stroke="#0284c7" stroke-width="2"/>
  <text x="140" y="110" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#0369a1">CandidateSet(e)</text>
  <text x="140" y="135" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#334155">All registered validators</text>
  <text x="140" y="155" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#334155">from ledger state</text>
  <text x="140" y="180" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#64748b">(Sorted by ValidatorId)</text>
  
  <!-- Arrow 1 -->
  <line x1="230" y1="140" x2="280" y2="140" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Stake Filter Box -->
  <rect x="290" y="100" width="140" height="80" rx="8" fill="#fef3c7" stroke="#d97706" stroke-width="2"/>
  <text x="360" y="130" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#92400e">Stake Filter</text>
  <text x="360" y="150" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#78350f">stake ≥ min_stake</text>
  <text x="360" y="165" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#a16207">(M2.1/M2.2)</text>
  
  <!-- Arrow 2 -->
  <line x1="430" y1="140" x2="480" y2="140" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- Jail Filter Box -->
  <rect x="490" y="100" width="140" height="80" rx="8" fill="#fee2e2" stroke="#dc2626" stroke-width="2"/>
  <text x="560" y="130" font-family="Arial, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#991b1b">Jail Filter</text>
  <text x="560" y="150" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#7f1d1d">e ≥ jailed_until</text>
  <text x="560" y="165" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#b91c1c">(M9)</text>
  
  <!-- Arrow 3 -->
  <line x1="630" y1="140" x2="680" y2="140" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- ActiveSet Box -->
  <rect x="690" y="80" width="160" height="120" rx="8" fill="#d1fae5" stroke="#059669" stroke-width="2"/>
  <text x="770" y="110" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#047857">ValidatorSet(e)</text>
  <text x="770" y="130" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#166534">(ActiveSet)</text>
  <text x="770" y="155" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#334155">Eligible validators</text>
  <text x="770" y="175" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#334155">sorted by ValidatorId</text>
  
  <!-- Excluded Boxes -->
  <!-- Low Stake Excluded -->
  <rect x="290" y="220" width="140" height="60" rx="6" fill="#fef9c3" stroke="#ca8a04" stroke-width="1.5" stroke-dasharray="4,2"/>
  <text x="360" y="245" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#854d0e">ExcludedLowStake</text>
  <text x="360" y="265" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#a16207">stake &lt; min_stake</text>
  <line x1="360" y1="180" x2="360" y2="220" stroke="#ca8a04" stroke-width="1.5" stroke-dasharray="4,2"/>
  
  <!-- Jailed Excluded -->
  <rect x="490" y="220" width="140" height="60" rx="6" fill="#fecaca" stroke="#b91c1c" stroke-width="1.5" stroke-dasharray="4,2"/>
  <text x="560" y="245" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#7f1d1d">ExcludedJailed</text>
  <text x="560" y="265" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#b91c1c">e &lt; jailed_until</text>
  <line x1="560" y1="180" x2="560" y2="220" stroke="#b91c1c" stroke-width="1.5" stroke-dasharray="4,2"/>
  
  <!-- Outputs Section -->
  <rect x="50" y="320" width="800" height="250" rx="10" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1"/>
  <text x="450" y="350" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#1e293b">Derived Properties from ValidatorSet(e)</text>
  
  <!-- Voting Power Box -->
  <rect x="80" y="380" width="230" height="90" rx="6" fill="#ede9fe" stroke="#7c3aed" stroke-width="1.5"/>
  <text x="195" y="405" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#5b21b6">Voting Power</text>
  <text x="195" y="430" font-family="monospace" font-size="10" text-anchor="middle" fill="#334155">VotingPowerSum = Σ vp(v)</text>
  <text x="195" y="455" font-family="monospace" font-size="10" text-anchor="middle" fill="#334155">Quorum = ⌈2·VPS/3⌉</text>
  
  <!-- Leader Schedule Box -->
  <rect x="335" y="380" width="230" height="90" rx="6" fill="#fce7f3" stroke="#db2777" stroke-width="1.5"/>
  <text x="450" y="405" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#9d174d">Leader Schedule</text>
  <text x="450" y="430" font-family="monospace" font-size="10" text-anchor="middle" fill="#334155">leader(view) =</text>
  <text x="450" y="450" font-family="monospace" font-size="10" text-anchor="middle" fill="#334155">ValSet[view mod |ValSet|]</text>
  
  <!-- Consensus Box -->
  <rect x="590" y="380" width="230" height="90" rx="6" fill="#dbeafe" stroke="#2563eb" stroke-width="1.5"/>
  <text x="705" y="405" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#1d4ed8">Consensus</text>
  <text x="705" y="430" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#334155">QC formation</text>
  <text x="705" y="450" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#334155">Vote accumulation</text>
  <text x="705" y="470" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#334155">Block commit</text>
  
  <!-- Arrows from ActiveSet to derived properties -->
  <path d="M 770 200 L 770 300 L 195 300 L 195 380" fill="none" stroke="#2563eb" stroke-width="1.5" marker-end="url(#arrowhead-blue)"/>
  <path d="M 770 200 L 770 300 L 450 300 L 450 380" fill="none" stroke="#2563eb" stroke-width="1.5" marker-end="url(#arrowhead-blue)"/>
  <path d="M 770 200 L 770 300 L 705 300 L 705 380" fill="none" stroke="#2563eb" stroke-width="1.5" marker-end="url(#arrowhead-blue)"/>
  
  <!-- Fail-Closed Note -->
  <rect x="80" y="495" width="740" height="50" rx="6" fill="#fef2f2" stroke="#ef4444" stroke-width="1.5"/>
  <text x="450" y="517" font-family="Arial, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#b91c1c">FAIL-CLOSED: If |ValidatorSet(e)| = 0, epoch transition MUST fail.</text>
  <text x="450" y="535" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#7f1d1d">An empty validator set cannot form quorum. Node halts with StakeFilterEmptySetError.</text>
  
  <!-- Legend -->
  <text x="50" y="580" font-family="Arial, sans-serif" font-size="9" fill="#64748b">Legend: Solid boxes = active sets | Dashed boxes = excluded validators | Blue arrows = data flow to consensus</text>
</svg>
