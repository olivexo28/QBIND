<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 950 550" width="950" height="550">
  <defs>
    <style>
      .title { font: bold 18px sans-serif; fill: #333; }
      .box-text { font: 12px sans-serif; fill: #333; text-anchor: middle; dominant-baseline: middle; }
      .service-text { font: 11px sans-serif; fill: #333; text-anchor: middle; dominant-baseline: middle; }
      .label-text { font: 10px sans-serif; fill: #555; }
      .callout-text { font: 9px sans-serif; fill: #444; }
      .layer-label { font: italic 10px sans-serif; fill: #666; }
    </style>
    <!-- Arrow markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
    <marker id="arrowhead-start" markerWidth="10" markerHeight="7" refX="1" refY="3.5" orient="auto">
      <polygon points="10 0, 0 3.5, 10 7" fill="#666"/>
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="950" height="550" fill="#ffffff"/>
  
  <!-- Title -->
  <text x="475" y="30" class="title" text-anchor="middle">QBIND Node Runtime and Execution Flow</text>
  
  <!-- Tokio Runtime Container -->
  <rect x="50" y="50" width="750" height="200" rx="10" fill="#e8f4f8" stroke="#4a90a4" stroke-width="2"/>
  <text x="425" y="75" class="box-text" style="font-weight: bold;">Tokio Runtime (multi-threaded)</text>
  
  <!-- Services inside Tokio Runtime - horizontally aligned -->
  
  <!-- P2P Service -->
  <rect x="70" y="100" width="100" height="50" rx="6" fill="#d5e8d4" stroke="#82b366" stroke-width="2"/>
  <text x="120" y="125" class="service-text">P2P Service</text>
  
  <!-- Consensus Runner -->
  <rect x="200" y="100" width="110" height="50" rx="6" fill="#f8cecc" stroke="#b85450" stroke-width="2"/>
  <text x="255" y="125" class="service-text">Consensus Runner</text>
  
  <!-- Mempool Service -->
  <rect x="340" y="100" width="100" height="50" rx="6" fill="#e1d5e7" stroke="#9673a6" stroke-width="2"/>
  <text x="390" y="125" class="service-text">Mempool Service</text>
  
  <!-- Execution Worker -->
  <rect x="470" y="100" width="110" height="50" rx="6" fill="#ffe6cc" stroke="#d79b00" stroke-width="2"/>
  <text x="525" y="125" class="service-text">Execution Worker</text>
  
  <!-- Verification Pool -->
  <rect x="610" y="100" width="100" height="50" rx="6" fill="#dae8fc" stroke="#6c8ebf" stroke-width="2"/>
  <text x="660" y="125" class="service-text">Verification Pool</text>
  
  <!-- Metrics Server -->
  <rect x="70" y="180" width="100" height="50" rx="6" fill="#f5f5f5" stroke="#666666" stroke-width="2"/>
  <text x="120" y="205" class="service-text">Metrics Server</text>
  
  <!-- Communication Arrows -->
  
  <!-- P2P Service → Consensus Runner (solid, mpsc channel) -->
  <line x1="170" y1="125" x2="195" y2="125" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="182" y="118" class="label-text" text-anchor="middle">mpsc</text>
  
  <!-- Consensus Runner → P2P Service (broadcast, below the forward arrow) -->
  <path d="M 200 140 L 170 140" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="182" y="155" class="label-text" text-anchor="middle">broadcast</text>
  
  <!-- Consensus Runner ⇄ Mempool (dashed double-arrow, Arc shared state) -->
  <line x1="310" y1="125" x2="335" y2="125" stroke="#666" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-start)"/>
  <text x="322" y="118" class="label-text" text-anchor="middle">Arc</text>
  <text x="322" y="108" class="label-text" text-anchor="middle" style="font-size: 8px;">shared state</text>
  
  <!-- Consensus Runner → Execution Worker (solid, mpsc channel) -->
  <line x1="310" y1="135" x2="465" y2="135" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="387" y="150" class="label-text" text-anchor="middle">mpsc channel</text>
  
  <!-- RocksDB Storage Box -->
  <rect x="420" y="320" width="210" height="60" rx="8" fill="#f5f5f5" stroke="#666666" stroke-width="2"/>
  <text x="525" y="350" class="box-text">RocksDB</text>
  
  <!-- Execution Worker → RocksDB (solid arrow downward) -->
  <line x1="525" y1="150" x2="525" y2="315" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="540" y="240" class="label-text">Persist block /</text>
  <text x="540" y="252" class="label-text">QC / last_committed</text>
  
  <!-- Side Callout Boxes -->
  
  <!-- Callout 1: Bounded channel capacity -->
  <rect x="730" y="90" width="200" height="40" rx="5" fill="#fffde7" stroke="#fbc02d" stroke-width="1"/>
  <text x="830" y="107" class="callout-text" text-anchor="middle">Bounded channel capacity: 1024</text>
  <text x="830" y="120" class="callout-text" text-anchor="middle">(backpressure)</text>
  
  <!-- Callout 2: Fatal errors -->
  <rect x="730" y="145" width="200" height="30" rx="5" fill="#ffebee" stroke="#ef5350" stroke-width="1"/>
  <text x="830" y="163" class="callout-text" text-anchor="middle">Fatal errors terminate process</text>
  
  <!-- Callout 3: Commit order -->
  <rect x="730" y="190" width="200" height="45" rx="5" fill="#e8f5e9" stroke="#66bb6a" stroke-width="1"/>
  <text x="830" y="207" class="callout-text" text-anchor="middle">Commit order:</text>
  <text x="830" y="222" class="callout-text" text-anchor="middle">Execute → Block → QC →</text>
  <text x="830" y="237" class="callout-text" text-anchor="middle">LastCommitted</text>
  
  <!-- Legend -->
  <rect x="50" y="420" width="300" height="80" rx="5" fill="#fafafa" stroke="#ccc" stroke-width="1"/>
  <text x="60" y="440" class="label-text" style="font-weight: bold;">Legend:</text>
  
  <!-- Solid arrow legend -->
  <line x1="60" y1="460" x2="100" y2="460" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="110" y="463" class="label-text">mpsc channel (async message passing)</text>
  
  <!-- Dashed arrow legend -->
  <line x1="60" y1="485" x2="100" y2="485" stroke="#666" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead)" marker-start="url(#arrowhead-start)"/>
  <text x="110" y="488" class="label-text">Arc&lt;Mutex/RwLock&gt; shared state</text>
  
  <!-- Footer note -->
  <text x="50" y="530" class="layer-label">Runtime interaction diagram: shows how async services communicate via channels and shared state at execution time.</text>
</svg>
