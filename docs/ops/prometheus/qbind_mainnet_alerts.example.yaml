# QBIND MainNet v0 Prometheus Alert Rules
#
# Task: T216
# Version: 1.0.0
# Date: 2026-02-07
#
# This file provides example alert rules for QBIND MainNet v0 validators.
# Operators should adapt thresholds based on their specific requirements.
#
# Usage:
#   1. Copy to your Prometheus rules directory
#   2. Adjust thresholds as needed
#   3. Reload Prometheus configuration
#
# Note: All metric names reference metrics defined in qbind-node/src/metrics.rs

groups:
  # ==========================================================================
  # Consensus Health Alerts
  # ==========================================================================
  - name: qbind_consensus
    rules:
      # Alert when consensus view lag is too high
      - alert: QbindConsensusViewLagHigh
        expr: qbind_consensus_view_lag > 10
        for: 5m
        labels:
          severity: warning
          component: consensus
        annotations:
          summary: "Consensus view lag is high"
          description: "Validator {{ $labels.instance }} has view lag of {{ $value }} (threshold: 10). Node may be falling behind network."
          runbook_url: "https://docs.qbind.network/runbook#consensus-view-lag"

      # Critical: Consensus view lag extremely high
      - alert: QbindConsensusViewLagCritical
        expr: qbind_consensus_view_lag > 50
        for: 2m
        labels:
          severity: critical
          component: consensus
        annotations:
          summary: "Consensus view lag is critically high"
          description: "Validator {{ $labels.instance }} has view lag of {{ $value }} (threshold: 50). Immediate investigation required."
          runbook_url: "https://docs.qbind.network/runbook#consensus-view-lag"

      # Alert when no QCs formed for extended period
      - alert: QbindConsensusNoQCsFormed
        expr: rate(qbind_consensus_qcs_formed_total[5m]) == 0
        for: 10m
        labels:
          severity: critical
          component: consensus
        annotations:
          summary: "No quorum certificates formed"
          description: "Validator {{ $labels.instance }} has not formed any QCs in the last 10 minutes. Consensus may be stalled."
          runbook_url: "https://docs.qbind.network/runbook#consensus-stalled"

      # Alert on excessive view changes (potential liveness issues)
      - alert: QbindConsensusExcessiveViewChanges
        expr: rate(qbind_consensus_view_changes_total[5m]) > 0.2
        for: 5m
        labels:
          severity: warning
          component: consensus
        annotations:
          summary: "Excessive consensus view changes"
          description: "Validator {{ $labels.instance }} is experiencing {{ $value | printf \"%.2f\" }} view changes per second. May indicate network issues."
          runbook_url: "https://docs.qbind.network/runbook#view-changes"

      # Alert on QC formation latency
      - alert: QbindConsensusQCLatencyHigh
        expr: histogram_quantile(0.95, rate(qbind_consensus_qc_formation_latency_ms_bucket[5m])) > 2000
        for: 5m
        labels:
          severity: warning
          component: consensus
        annotations:
          summary: "QC formation latency is high"
          description: "95th percentile QC formation latency on {{ $labels.instance }} is {{ $value | printf \"%.0f\" }}ms (threshold: 2000ms)."
          runbook_url: "https://docs.qbind.network/runbook#qc-latency"

  # ==========================================================================
  # P2P Health Alerts
  # ==========================================================================
  - name: qbind_p2p
    rules:
      # Alert when outbound peer count is too low
      - alert: QbindP2POutboundPeersLow
        expr: qbind_p2p_outbound_peers < 3
        for: 5m
        labels:
          severity: warning
          component: p2p
        annotations:
          summary: "Outbound peer count is low"
          description: "Validator {{ $labels.instance }} has only {{ $value }} outbound peers (minimum: 3). Risk of network isolation."
          runbook_url: "https://docs.qbind.network/runbook#p2p-peers"

      # Critical: No outbound peers
      - alert: QbindP2PNoOutboundPeers
        expr: qbind_p2p_outbound_peers == 0
        for: 2m
        labels:
          severity: critical
          component: p2p
        annotations:
          summary: "No outbound peers connected"
          description: "Validator {{ $labels.instance }} has no outbound peers. Node is isolated from network."
          runbook_url: "https://docs.qbind.network/runbook#p2p-isolated"

      # Alert on excessive diversity rejections
      - alert: QbindP2PDiversityRejectionsHigh
        expr: rate(qbind_p2p_peer_rejected_diversity_total[5m]) > 1
        for: 10m
        labels:
          severity: warning
          component: p2p
        annotations:
          summary: "High peer diversity rejection rate"
          description: "Validator {{ $labels.instance }} is rejecting {{ $value | printf \"%.2f\" }} peers/sec due to diversity constraints."
          runbook_url: "https://docs.qbind.network/runbook#p2p-diversity"

      # Alert on peer evictions due to liveness
      - alert: QbindP2PLivenessEvictionsHigh
        expr: rate(qbind_p2p_peer_evicted_total{reason="liveness"}[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          component: p2p
        annotations:
          summary: "High peer liveness eviction rate"
          description: "Validator {{ $labels.instance }} is evicting {{ $value | printf \"%.2f\" }} peers/sec for unresponsiveness."
          runbook_url: "https://docs.qbind.network/runbook#p2p-liveness"

      # Alert on heartbeat failures
      - alert: QbindP2PHeartbeatFailuresHigh
        expr: rate(qbind_p2p_heartbeat_failed_total[5m]) / rate(qbind_p2p_heartbeat_sent_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: p2p
        annotations:
          summary: "High P2P heartbeat failure rate"
          description: "Validator {{ $labels.instance }} has {{ $value | printf \"%.1f%%\" }} heartbeat failure rate."
          runbook_url: "https://docs.qbind.network/runbook#p2p-heartbeat"

      # Alert on low diversity bucket count
      - alert: QbindP2PDiversityBucketsLow
        expr: qbind_p2p_diversity_distinct_buckets < 4
        for: 10m
        labels:
          severity: warning
          component: p2p
        annotations:
          summary: "Peer network diversity is low"
          description: "Validator {{ $labels.instance }} has peers in only {{ $value }} distinct network buckets. Potential eclipse risk."
          runbook_url: "https://docs.qbind.network/runbook#p2p-diversity"

  # ==========================================================================
  # Signer / HSM / Remote Signer Alerts
  # ==========================================================================
  - name: qbind_signer
    rules:
      # Alert on HSM errors
      - alert: QbindHSMErrorRateHigh
        expr: |
          rate(qbind_hsm_sign_error_total[5m])
          / (rate(qbind_hsm_sign_success_total[5m]) + rate(qbind_hsm_sign_error_total[5m]) + 0.001)
          > 0.05
        for: 2m
        labels:
          severity: critical
          component: signer
        annotations:
          summary: "HSM signing error rate is high"
          description: "Validator {{ $labels.instance }} HSM error rate is {{ $value | printf \"%.1f%%\" }} (threshold: 5%)."
          runbook_url: "https://docs.qbind.network/runbook#hsm-errors"

      # Alert on HSM startup failure
      - alert: QbindHSMStartupFailed
        expr: qbind_hsm_startup_ok == 0
        for: 1m
        labels:
          severity: critical
          component: signer
        annotations:
          summary: "HSM startup health check failed"
          description: "Validator {{ $labels.instance }} failed HSM startup health check. Signing operations may fail."
          runbook_url: "https://docs.qbind.network/runbook#hsm-startup"

      # Alert on remote signer failures
      - alert: QbindRemoteSignerFailuresHigh
        expr: |
          sum(rate(qbind_remote_sign_failures_total[5m]))
          / (sum(rate(qbind_remote_sign_requests_total[5m])) + 0.001)
          > 0.05
        for: 2m
        labels:
          severity: critical
          component: signer
        annotations:
          summary: "Remote signer failure rate is high"
          description: "Validator {{ $labels.instance }} remote signer failure rate is {{ $value | printf \"%.1f%%\" }} (threshold: 5%)."
          runbook_url: "https://docs.qbind.network/runbook#remote-signer-failures"

      # Alert on remote signer transport errors
      - alert: QbindRemoteSignerTransportErrors
        expr: rate(qbind_remote_sign_failures_total{reason="transport"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          component: signer
        annotations:
          summary: "Remote signer transport errors"
          description: "Validator {{ $labels.instance }} experiencing {{ $value | printf \"%.2f\" }} transport errors/sec to remote signer."
          runbook_url: "https://docs.qbind.network/runbook#remote-signer-transport"

      # Alert on total signer failures
      - alert: QbindSignerFailuresTotal
        expr: rate(qbind_signer_sign_failures_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          component: signer
        annotations:
          summary: "Validator signer failures"
          description: "Validator {{ $labels.instance }} experiencing {{ $value | printf \"%.2f\" }} signer failures/sec."
          runbook_url: "https://docs.qbind.network/runbook#signer-failures"

  # ==========================================================================
  # State & Storage Alerts
  # ==========================================================================
  - name: qbind_state
    rules:
      # Alert on state size threshold
      - alert: QbindStateSizeLarge
        expr: qbind_state_size_bytes > 100 * 1024 * 1024 * 1024  # 100 GB
        for: 5m
        labels:
          severity: warning
          component: state
        annotations:
          summary: "State size is large"
          description: "Validator {{ $labels.instance }} state size is {{ $value | humanize1024 }}. Consider reviewing pruning settings."
          runbook_url: "https://docs.qbind.network/runbook#state-size"

      # Critical: State size very large
      - alert: QbindStateSizeCritical
        expr: qbind_state_size_bytes > 500 * 1024 * 1024 * 1024  # 500 GB
        for: 5m
        labels:
          severity: critical
          component: state
        annotations:
          summary: "State size is critically large"
          description: "Validator {{ $labels.instance }} state size is {{ $value | humanize1024 }}. Disk exhaustion risk."
          runbook_url: "https://docs.qbind.network/runbook#state-size-critical"

      # Alert on snapshot failures
      - alert: QbindSnapshotFailures
        expr: increase(qbind_snapshot_failure_total[1h]) > 0
        for: 5m
        labels:
          severity: warning
          component: state
        annotations:
          summary: "Snapshot creation failed"
          description: "Validator {{ $labels.instance }} had {{ $value }} snapshot failures in the last hour."
          runbook_url: "https://docs.qbind.network/runbook#snapshot-failures"

      # Alert on snapshot not progressing
      - alert: QbindSnapshotStale
        expr: time() - qbind_snapshot_last_created_at_ms / 1000 > 7 * 24 * 3600  # 7 days
        for: 1h
        labels:
          severity: warning
          component: state
        annotations:
          summary: "No recent snapshots"
          description: "Validator {{ $labels.instance }} last snapshot was {{ $value | humanizeDuration }} ago."
          runbook_url: "https://docs.qbind.network/runbook#snapshot-stale"

      # Alert on pruning not keeping pace
      - alert: QbindPruningNotProgressing
        expr: |
          increase(qbind_state_prune_keys_pruned_total[1h]) == 0
          and qbind_state_size_bytes > 50 * 1024 * 1024 * 1024
        for: 4h
        labels:
          severity: warning
          component: state
        annotations:
          summary: "State pruning not progressing"
          description: "Validator {{ $labels.instance }} has not pruned any keys in 1 hour despite large state size."
          runbook_url: "https://docs.qbind.network/runbook#pruning-stuck"

  # ==========================================================================
  # Monetary Policy Alerts
  # ==========================================================================
  - name: qbind_monetary
    rules:
      # Alert on unexpected inflation rate change
      - alert: QbindMonetaryInflationJump
        expr: |
          abs(delta(qbind_monetary_r_inf_annual_bps[1h])) > 50
        for: 5m
        labels:
          severity: warning
          component: monetary
        annotations:
          summary: "Inflation rate changed unexpectedly"
          description: "Validator {{ $labels.instance }} observed {{ $value }}bps change in annual inflation rate."
          runbook_url: "https://docs.qbind.network/runbook#monetary-inflation"

      # Informational: Phase transition may be appropriate
      - alert: QbindMonetaryPhaseAdvanceRecommended
        expr: qbind_monetary_phase_recommendation == 1
        for: 1h
        labels:
          severity: info
          component: monetary
        annotations:
          summary: "Monetary phase advance recommended"
          description: "Validator {{ $labels.instance }} monetary engine recommends advancing to next phase."
          runbook_url: "https://docs.qbind.network/runbook#monetary-phase"

      # Alert on fee coverage dropping
      - alert: QbindMonetaryFeeCoverageDrop
        expr: |
          delta(qbind_monetary_fee_coverage_ratio_bps[1h]) < -100
        for: 30m
        labels:
          severity: warning
          component: monetary
        annotations:
          summary: "Fee coverage ratio dropped significantly"
          description: "Validator {{ $labels.instance }} fee coverage dropped by {{ $value | printf \"%.0f\" }}bps in the last hour."
          runbook_url: "https://docs.qbind.network/runbook#monetary-fees"

  # ==========================================================================
  # DAG Coupling Alerts
  # ==========================================================================
  - name: qbind_dag
    rules:
      # Alert on DAG coupling validation failures
      - alert: QbindDAGCouplingFailures
        expr: rate(qbind_dag_coupling_rejected_total[5m]) > 0
        for: 2m
        labels:
          severity: warning
          component: dag
        annotations:
          summary: "DAG coupling validation failures"
          description: "Validator {{ $labels.instance }} rejecting proposals due to DAG coupling issues."
          runbook_url: "https://docs.qbind.network/runbook#dag-coupling"

      # Alert on missing DAG batches
      - alert: QbindDAGMissingBatches
        expr: increase(qbind_dag_coupling_block_missing_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
          component: dag
        annotations:
          summary: "Missing DAG batches detected"
          description: "Validator {{ $labels.instance }} detected {{ $value }} missing batches in committed blocks."
          runbook_url: "https://docs.qbind.network/runbook#dag-missing"

  # ==========================================================================
  # Execution Alerts
  # ==========================================================================
  - name: qbind_execution
    rules:
      # Alert on execution errors
      - alert: QbindExecutionErrors
        expr: rate(qbind_execution_errors_total[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          component: execution
        annotations:
          summary: "High execution error rate"
          description: "Validator {{ $labels.instance }} experiencing {{ $value | printf \"%.2f\" }} execution errors/sec."
          runbook_url: "https://docs.qbind.network/runbook#execution-errors"

      # Alert on block apply latency
      - alert: QbindBlockApplyLatencyHigh
        expr: histogram_quantile(0.95, rate(qbind_execution_block_apply_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          component: execution
        annotations:
          summary: "Block apply latency is high"
          description: "95th percentile block apply latency on {{ $labels.instance }} is {{ $value | printf \"%.2f\" }}s."
          runbook_url: "https://docs.qbind.network/runbook#execution-latency"

      # Alert on Stage B mismatch (determinism failure)
      - alert: QbindStageBMismatch
        expr: increase(qbind_execution_stage_b_mismatch_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: execution
        annotations:
          summary: "Stage B determinism mismatch detected"
          description: "Validator {{ $labels.instance }} detected parallel/sequential execution mismatch. Critical bug."
          runbook_url: "https://docs.qbind.network/runbook#stage-b-mismatch"

  # ==========================================================================
  # General Node Health Alerts
  # ==========================================================================
  - name: qbind_node
    rules:
      # Alert on mempool full
      - alert: QbindMempoolFull
        expr: rate(qbind_mempool_rejected_total{reason="full"}[5m]) > 1
        for: 10m
        labels:
          severity: warning
          component: mempool
        annotations:
          summary: "Mempool is full"
          description: "Validator {{ $labels.instance }} rejecting {{ $value | printf \"%.2f\" }} txs/sec due to full mempool."
          runbook_url: "https://docs.qbind.network/runbook#mempool-full"